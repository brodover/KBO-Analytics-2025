<div class="p-6 md:p-10 bg-gray-50 min-h-screen">
    <h1 class="text-3xl font-extrabold text-indigo-800 mb-6 border-b pb-2">
        Pitch Tunnel & Timing Disruption Model
    </h1>

    @if (isLoading()) {
    <!-- Loading State -->
    <div class="flex items-center justify-center p-10 bg-white rounded-xl shadow-lg">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
    </div>
    } @else {
    <!-- Pitcher Selection and Analysis Controls -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 space-y-4">
        <div class="text-sm text-gray-500 mb-4 italic">
            Loaded {{ allPitches().length | number }} total pitches.
        </div>
        <!-- Team Selection Dropdown -->
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <label for="team-select" class="font-semibold text-gray-700 whitespace-nowrap">
                Select Team:
            </label>
            <select id="team-select" [ngModel]="selectedTeam()" (change)="selectTeam($event)"
                class="flex-grow p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <option [value]="null" disabled>-- Choose a Team --</option>
                @for (team of allTeams(); track team) {
                <option [value]="team">{{ team }}</option>
                }
            </select>
        </div>

        <!-- Pitcher Selection Dropdown (Now dependent on Team) -->
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <label for="pitcher-select" class="font-semibold text-gray-700 whitespace-nowrap">
                Select Pitcher:
            </label>
            <select id="pitcher-select" [ngModel]="selectedPitcher()" (change)="selectPitcher($event)"
                [disabled]="!selectedTeam()"
                class="flex-grow p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 transition duration-150">
                <option [value]="null" disabled>-- Choose a Pitcher --</option>
                @for (pitcher of uniquePitchers(); track pitcher) {
                <option [value]="pitcher">{{ pitcher }}</option>
                }
            </select>
        </div>

        <!-- Delivery Mode Selection -->
        <div class="flex items-center gap-4">
            <label class="font-semibold text-gray-700">Delivery Mode:</label>
            <select [ngModel]="deliveryMode()" (ngModelChange)="deliveryMode.set($event)"
                class="p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <option value="both">Both (Windup & Stretch)</option>
                <option value="windup">Windup Only (is_throwing_stretch=False)</option>
                <option value="stretch">Stretch Only (is_throwing_stretch=True)</option>
            </select>
        </div>

        <button (click)="runAnalysis(0.150)" [disabled]="!selectedPitcher() || pitcherPitchTypes().length < 2"
            class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-indigo-300 transition duration-150">
            Run Tunnel Analysis at 150ms ({{ filteredPitches().length }} Pitches)
        </button>
        <p class="text-xs text-gray-500 italic mt-1">Analysis uses the average parameters for each pitch type after
            filtering.</p>
    </div>

    @if (selectedPitcher()) {
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">
        Analysis Results for {{ selectedPitcher() }} ({{ deliveryMode() | titlecase }})
    </h2>
    @if (analysisResults().length === 0 && filteredPitches().length === 0) {
    <p class="text-gray-500 italic p-4 bg-white rounded-lg shadow">
        No pitches found matching the selected pitcher and delivery mode.
    </p>
    } @else if (analysisResults().length === 0) {
    <p class="text-gray-500 italic p-4 bg-white rounded-lg shadow">
        Select a pitcher and click "Analyze" to run the tunnel comparison. (Need at least 2 pitch types.)
    </p>
    } @else {
    <div class="bg-white rounded-xl shadow-xl p-4 mb-8">
        <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">Pitch Tunnel Visualization (Batter's POV)
        </h3>
        <p class="text-sm text-gray-500 mb-4">Larger dot: average release point. Smaller dot: average ball location at 150ms.</p>
        <!-- CANVAS FOR VISUALIZATION -->
        <canvas #tunnelCanvas id="tunnelCanvas" width="570" height="500"
            class="w-full h-auto max-w-lg mx-auto border border-gray-300 rounded-lg shadow-inner"></canvas>
    </div>
    <!-- Results Table -->
    <div class="bg-white rounded-xl shadow-xl overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-indigo-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Pitch
                        Pair</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Release
                        Distance (ft)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Tunnel
                        Distance (150ms) (ft)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Timing
                        Disruption</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                @for (result of analysisResults(); track result.pitch_type_a) {
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ result.pitch_type_a }} vs. {{ result.pitch_type_b }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ result.release_dist_2d | number: '1.3-3' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span [class]="result.tunnel_dist_2d > 0.1 ? 'font-bold text-red-600' : 'text-green-600'">
                            {{ result.tunnel_dist_2d | number: '1.3-3' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ result.path_separation_ms }}
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Interpretation Guide -->
    <div class="mt-8 p-6 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">Interpretation Guide: Tunneling</h3>
        <p class="text-sm text-yellow-700">
            A **smaller Tunnel Distance (e.g., < 0.05 ft)** means the average paths stay similar longer (good
                tunneling). A **larger Tunnel Distance (e.g.,> 0.1 ft)** suggests the pitches separate too early for the
                hitter to judge, indicating a potential tipping mechanism.
                This analysis compares the average flight path for each pitch type after 150ms of travel.
        </p>
    </div>
    }
    }
    }
</div>